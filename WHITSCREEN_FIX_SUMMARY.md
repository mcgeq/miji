# Tauri æ‰“åŒ…ç™½å±é—®é¢˜ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

### ç—‡çŠ¶
- âœ… å¼€å‘æ¨¡å¼ (`bun run tauri dev`) å®Œå…¨æ­£å¸¸
- âŒ æ‰“åŒ…å (`bun run tauri build`) ç™½å±
- âœ… åç«¯æ—¥å¿—æ­£å¸¸ï¼ˆæ•°æ®åº“ã€è¿ç§»ã€è°ƒåº¦å™¨å…¨éƒ¨æˆåŠŸï¼‰
- âŒ å‰ç«¯ JavaScript å®Œå…¨ä¸æ‰§è¡Œæˆ–æ‰§è¡Œå¤±è´¥

### æ ¹æœ¬åŸå› 

**ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š**

1. **æ•°æ®åº“è¿ç§»ç¼ºå°‘ on_conflict å¤„ç†** âš ï¸
   - é‡æ–°å®‰è£…æ—¶ï¼Œæ’å…¥é»˜è®¤æ•°æ®å¯¼è‡´å”¯ä¸€çº¦æŸå†²çª
   - è¿ç§»å¤±è´¥ â†’ åº”ç”¨å¯åŠ¨å¤±è´¥ â†’ ç™½å±

2. **Vite ä»£ç åˆ†å‰² + å¾ªç¯ä¾èµ–** ğŸ”´
   - `main.ts` â†’ `initMoneyStores` â†’ `useAccountStore` â†’ `money-feature` â†’ ...
   - æ¨¡å—åˆå§‹åŒ–é¡ºåºé”™è¯¯
   - é”™è¯¯: `Uncaught ReferenceError: Cannot access 'r' before initialization`

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: æ•°æ®åº“è¿ç§»æ·»åŠ  on_conflict

**ä¿®æ”¹æ–‡ä»¶:**
- `src-tauri/migration/src/m20251122_002_create_currency.rs`
- `src-tauri/migration/src/m20251122_004_create_categories.rs`
- `src-tauri/migration/src/m20251122_005_create_sub_categories.rs`

**ä¿®æ”¹å†…å®¹:**
```rust
// âŒ ä¹‹å‰
Query::insert()
    .values_panic([...])
    .to_owned()

// âœ… ä¿®å¤å
Query::insert()
    .values_panic([...])
    .on_conflict(
        sea_query::OnConflict::column(PrimaryKey)
            .do_nothing()
            .to_owned()
    )
    .to_owned()
```

### ä¿®å¤ 2: ç¦ç”¨åº”ç”¨ä»£ç çš„è¿‡åº¦åˆ†å‰²

**ä¿®æ”¹æ–‡ä»¶:** `vite.config.ts`

**ä¿®æ”¹å†…å®¹:**
```typescript
// âŒ ä¹‹å‰ - è¿‡åº¦åˆ†å‰²å¯¼è‡´å¾ªç¯ä¾èµ–
if (id.includes('/src/stores/')) return 'stores';
if (id.includes('/src/features/money/')) return 'money-feature';
// ... æ›´å¤šåˆ†å‰²

// âœ… ä¿®å¤å - åªåˆ†å‰²ç¬¬ä¸‰æ–¹åº“å’Œ utils
// åº”ç”¨ä»£ç åˆ†ç»„
// æ³¨æ„: ä¸å¯¹ stores å’Œ features è¿›è¡Œç‹¬ç«‹æ‰“åŒ…ï¼Œé¿å…å¾ªç¯ä¾èµ–
if (id.includes('/src/')) {
  if (id.includes('/src/utils/')) {
    return 'utils';
  }
}
```

### ä¿®å¤ 3: å¢å¼ºæ—¥å¿—ç³»ç»Ÿ

**ä¿®æ”¹æ–‡ä»¶:**
- `src/main.ts` - æ·»åŠ å¯åŠ¨æµç¨‹æ—¥å¿—
- `src/bootstrap/store-initializer.ts` - Store åˆå§‹åŒ–æ—¥å¿—
- `src/i18n/i18n.ts` - å›½é™…åŒ–åŠ è½½æ—¥å¿—

**æ–°å¢å·¥å…·:**
- `view-logs.ps1` - æ—¥å¿—æŸ¥çœ‹è„šæœ¬
- `build-debug.ps1` - è°ƒè¯•ç‰ˆæœ¬æ„å»ºè„šæœ¬
- `DEBUG_GUIDE.md` - è°ƒè¯•æŒ‡å—

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ¸…ç†ç¯å¢ƒ
```powershell
Remove-Item "$env:LOCALAPPDATA\com.mcgeq\miji.db" -Force -ErrorAction SilentlyContinue
```

### 2. é‡æ–°æ„å»º

**æ–¹å¼ 1: PowerShell è„šæœ¬ï¼ˆæ¨èï¼‰**
```powershell
.\build.ps1 -t windows -c
```

**æ–¹å¼ 2: Batch è„šæœ¬ï¼ˆæ— æƒé™é—®é¢˜ï¼‰**
```batch
build.bat -t windows -c
```

**æ–¹å¼ 3: npm è„šæœ¬**
```bash
bun run build:win           # PowerShell ç‰ˆæœ¬
bun run build:win:bat       # Batch ç‰ˆæœ¬
```

### 3. å®‰è£…æµ‹è¯•
- è¿è¡Œå®‰è£…åŒ…: `src-tauri\target\release\bundle\nsis\*.exe`
- åº”ç”¨åº”è¯¥æ­£å¸¸å¯åŠ¨
- åç«¯æ—¥å¿—: æ‰€æœ‰æ­¥éª¤æœ‰ âœ“ æ ‡è®°
- å‰ç«¯æ—¥å¿—: çœ‹åˆ° "=== åº”ç”¨å¯åŠ¨å®Œæˆ ==="

### 4. æŸ¥çœ‹æ—¥å¿—
```powershell
.\view-logs.ps1 -Follow
```

---

## ğŸ“ å·²ä¿ç•™çš„ä¿®æ”¹

### âœ… æ ¸å¿ƒä¿®å¤ï¼ˆå¿…é¡»ä¿ç•™ï¼‰

1. **æ•°æ®åº“è¿ç§» on_conflict** - 3 ä¸ªæ–‡ä»¶
   - é˜²æ­¢é‡æ–°å®‰è£…æ—¶å´©æºƒ
   - **ä¸å¯ç§»é™¤**

2. **Vite ä»£ç åˆ†å‰²ç®€åŒ–** - `vite.config.ts`
   - é¿å…å¾ªç¯ä¾èµ–å¯¼è‡´çš„åˆå§‹åŒ–é”™è¯¯
   - **ä¸å¯ç§»é™¤**

3. **å¢å¼ºçš„æ—¥å¿—ç³»ç»Ÿ** - å¤šä¸ªæ–‡ä»¶
   - å¸®åŠ©è¯Šæ–­æœªæ¥é—®é¢˜
   - **å»ºè®®ä¿ç•™**

### âŒ å·²ç§»é™¤çš„ä¸´æ—¶ä¿®æ”¹

1. ~~`console.log` è°ƒè¯•ä»£ç ~~ - å·²ç§»é™¤
2. ~~`devtools: true` é…ç½®~~ - å·²ç§»é™¤  
3. ~~`devtools` Cargo feature~~ - å·²ç§»é™¤

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ•°æ®åº“è¿ç§»æœ€ä½³å®è·µ
- âœ… **å¿…é¡»** ä½¿ç”¨ `on_conflict` å¤„ç†é»˜è®¤æ•°æ®æ’å…¥
- âœ… è€ƒè™‘å‡çº§åœºæ™¯ï¼Œä¸åªæ˜¯é¦–æ¬¡å®‰è£…
- âœ… è¿ç§»å¤±è´¥ = åº”ç”¨å´©æºƒ

### 2. Vite ä»£ç åˆ†å‰²ç­–ç•¥
- âš ï¸ è¿‡åº¦åˆ†å‰²å¯èƒ½å¯¼è‡´å¾ªç¯ä¾èµ–é—®é¢˜
- âœ… åªåˆ†å‰²ç¬¬ä¸‰æ–¹åº“é€šå¸¸å°±è¶³å¤Ÿ
- âœ… åº”ç”¨ä»£ç ä¿æŒåœ¨ä¸€èµ·æ›´å®‰å…¨
- ğŸ’¡ å¦‚éœ€åˆ†å‰²åº”ç”¨ä»£ç ï¼Œéœ€è¦ä»”ç»†è®¾è®¡æ¨¡å—ç»“æ„

### 3. è°ƒè¯•æ‰“åŒ…é—®é¢˜çš„æ–¹æ³•
- ğŸ” å¯¹æ¯”å¼€å‘å’Œç”Ÿäº§æ—¥å¿—
- ğŸ” ä½¿ç”¨ DevTools æŸ¥çœ‹å‰ç«¯é”™è¯¯ï¼ˆä¸´æ—¶å¯ç”¨ï¼‰
- ğŸ” ä½¿ç”¨ `tauri-plugin-log` è¾“å‡ºåˆ°æ–‡ä»¶
- ğŸ” åˆ›å»ºä¸“é—¨çš„æ—¥å¿—æŸ¥çœ‹å·¥å…·

### 4. å¾ªç¯ä¾èµ–çš„é¢„é˜²
- ğŸ“ ä¿æŒå•å‘ä¾èµ–: `main â†’ bootstrap â†’ stores â†’ services`
- ğŸ“ é¿å… stores ä¹‹é—´çš„ç›¸äº’å¯¼å…¥
- ğŸ“ ä½¿ç”¨äº‹ä»¶æ€»çº¿è§£è€¦æ¨¡å—

---

## ğŸš€ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. åˆ†æå¾ªç¯ä¾èµ–
```powershell
# ä½¿ç”¨å·¥å…·åˆ†æä¾èµ–å…³ç³»
npx madge --circular src
```

### 2. é‡æ„æ¨¡å—ç»“æ„
- æ¶ˆé™¤ stores ä¹‹é—´çš„å¾ªç¯ä¾èµ–
- æå–å…±äº«ç±»å‹åˆ°ç‹¬ç«‹æ¨¡å—
- ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼

### 3. ä¼˜åŒ–ä»£ç åˆ†å‰²
- åœ¨æ¶ˆé™¤å¾ªç¯ä¾èµ–åï¼Œå¯ä»¥é‡æ–°å¯ç”¨æ›´ç»†ç²’åº¦çš„åˆ†å‰²
- æµ‹è¯•ç¡®ä¿ä¸ä¼šé‡ç°åˆå§‹åŒ–é”™è¯¯

---

## ğŸ“ é—®é¢˜æ’æŸ¥æ¸…å•

å¦‚æœç™½å±é—®é¢˜å†æ¬¡å‡ºç°ï¼š

### âœ… æ£€æŸ¥åˆ—è¡¨

1. [ ] åç«¯æ—¥å¿—æ˜¯å¦æ­£å¸¸ï¼Ÿ
   ```powershell
   .\view-logs.ps1 -Lines 100
   ```

2. [ ] å‰ç«¯æ—¥å¿—æ˜¯å¦å­˜åœ¨ï¼Ÿ
   - çœ‹åˆ° "=== åº”ç”¨å¯åŠ¨å¼€å§‹ ===" è¯´æ˜å‰ç«¯æ­£å¸¸
   - æ²¡æœ‰çœ‹åˆ°è¯´æ˜ JS æœªæ‰§è¡Œ

3. [ ] DevTools Console æœ‰é”™è¯¯å—ï¼Ÿ
   - ä¸´æ—¶å¯ç”¨ `devtools: true`
   - æŒ‰ F12 æŸ¥çœ‹é”™è¯¯

4. [ ] èµ„æºè·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```powershell
   Get-Content dist/index.html | Select-String "src="
   # åº”è¯¥æ˜¯ ./assets/... è€Œä¸æ˜¯ /assets/...
   ```

5. [ ] æ˜¯å¦æœ‰æ–°çš„å¾ªç¯ä¾èµ–ï¼Ÿ
   ```powershell
   npx madge --circular src
   ```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `vite.config.ts` - Vite é…ç½®ï¼ˆä»£ç åˆ†å‰²ï¼‰
- `src-tauri/migration/src/m20251122_*.rs` - æ•°æ®åº“è¿ç§»ï¼ˆon_conflictï¼‰
- `src/main.ts` - åº”ç”¨å…¥å£ï¼ˆæ—¥å¿—å¢å¼ºï¼‰
- `view-logs.ps1` - æ—¥å¿—æŸ¥çœ‹å·¥å…·
- `build-debug.ps1` - è°ƒè¯•æ„å»ºè„šæœ¬
- `DEBUG_GUIDE.md` - è°ƒè¯•æŒ‡å—

---

## ğŸ‰ æ€»ç»“

**é—®é¢˜å·²å®Œå…¨è§£å†³ï¼** 

æ ¸å¿ƒä¿®å¤ï¼š
1. æ•°æ®åº“è¿ç§» on_conflict å¤„ç† âœ…
2. ç®€åŒ– Vite ä»£ç åˆ†å‰²ç­–ç•¥ âœ…
3. å¢å¼ºæ—¥å¿—ç³»ç»Ÿä¾¿äºè°ƒè¯• âœ…

åº”ç”¨ç°åœ¨å¯ä»¥æ­£å¸¸æ‰“åŒ…å¹¶è¿è¡Œï¼
