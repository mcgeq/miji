# 分摊记录数据迁移功能移除说明

## 📋 变更概述

**日期**: 2025-12-02  
**类型**: 功能废弃  
**影响**: 数据迁移功能已移除，UI 选项保留但禁用

---

## 🎯 变更原因

`split_members` JSON 字段已从 `transactions` 表中完全移除，所有分摊数据现在使用独立的规范化表结构：

- `split_records` - 分摊记录主表
- `split_record_details` - 分摊详情表

由于源字段已不存在，数据迁移功能已无实际意义，因此将其移除。

---

## 📝 变更详情

### 前端变更

**文件**: `src/features/settings/components/DataMigration.vue`

#### 移除的功能
- ❌ 迁移统计数据加载 (`loadStats`)
- ❌ 迁移执行功能 (`migrateSplitRecords`)
- ❌ 统计面板显示
- ❌ 迁移进度条
- ❌ 迁移结果展示
- ❌ 错误详情显示

#### 保留的内容
- ✅ UI 选项显示（设置 -> 数据 -> 分摊记录数据迁移）
- ✅ 图标和标题
- ✅ 功能说明文字

#### 新增内容
- ✅ 功能已废弃提示
- ✅ 历史数据说明
- ✅ 当前数据库架构说明

### 后端变更

#### 文件 1: `src-tauri/crates/money/src/command.rs`

**注释掉的函数**:
```rust
// migrate_split_records() - 迁移执行命令
// get_split_records_stats() - 统计信息查询命令
```

**注释掉的导入**:
```rust
// migration::MigrationResult
```

**添加的注释**:
- 标注功能已废弃
- 说明字段已从数据库移除
- 解释保留 UI 的原因

#### 文件 2: `src-tauri/src/commands.rs`

**注释掉的命令注册**:
```rust
// money_cmd::migrate_split_records,
// money_cmd::get_split_records_stats,
```

---

## 🔍 影响范围

### ✅ 无影响的功能

以下功能**不受影响**，继续正常工作：

1. **分摊记录创建**
   - 新交易的分摊配置
   - 自动生成 `split_records` 和 `split_record_details`

2. **分摊记录查询**
   - 查看交易的分摊详情
   - 成员分摊统计
   - 债务关系计算

3. **分摊记录管理**
   - 更新分摊记录
   - 修改付款状态
   - 删除分摊记录

4. **其他功能**
   - 交易管理
   - 账本管理
   - 预算功能
   - 所有其他设置功能

### ❌ 移除的功能

仅移除以下**已废弃**的功能：

1. **数据迁移执行**
   - 将 JSON 字段迁移到独立表（已无意义）

2. **迁移统计**
   - 待迁移交易数量统计（已无意义）
   - 迁移进度显示（已无意义）

---

## 📊 用户界面变化

### 设置页面 - 数据管理

**之前**:
```
┌─────────────────────────────────────────┐
│ 🗄️ 分摊记录数据迁移                      │
│                                         │
│ 当前状态:                                │
│ ├─ split_records 总数: 123              │
│ ├─ 已迁移交易: 50                       │
│ ├─ 待迁移交易: 30                       │
│ └─ 迁移进度: 62.5%                      │
│                                         │
│ [开始迁移] 按钮                          │
└─────────────────────────────────────────┘
```

**现在**:
```
┌─────────────────────────────────────────┐
│ 🗄️ 分摊记录数据迁移                      │
│                                         │
│ ℹ️ 此功能已废弃                          │
│ split_members 字段已从数据库移除         │
│ 新数据自动使用 split_records 表         │
│                                         │
│ ⚠️ 历史数据说明                          │
│ - 原字段已从数据库中移除                 │
│ - 历史记录已在移除前完成迁移             │
│ - 如有问题请联系技术支持                 │
│                                         │
│ 当前架构:                                │
│ • split_records - 分摊记录主表          │
│ • split_record_details - 分摊明细表     │
│ • 新交易自动创建相应记录                 │
└─────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 前端实现要点

1. **保留 UI 选项**
   - Card 组件保留
   - 标题和图标保留
   - 路由和导航保留

2. **简化逻辑**
   - 移除所有 API 调用
   - 移除状态管理
   - 移除事件处理

3. **添加说明**
   - 使用 Alert 组件显示废弃提示
   - 清晰说明当前架构
   - 提供联系方式

### 后端实现要点

1. **注释而非删除**
   - 保留代码但注释掉
   - 便于理解历史变更
   - 方便未来参考

2. **添加详细注释**
   - 说明废弃原因
   - 标注相关影响
   - 指明替代方案

3. **保持代码整洁**
   - 移除未使用的导入
   - 更新注释说明
   - 保持代码可读性

---

## 📚 相关文档

### 功能文档
- [分摊记录使用指南](./SPLIT_RECORDS_USAGE.md)
- [分摊记录实施指南](./SPLIT_RECORDS_IMPLEMENTATION.md)
- [分摊记录前端集成](./SPLIT_RECORDS_FRONTEND_GUIDE.md)

### 架构文档
- [数据库表结构](./database/)
- [API 文档](./API.md)

---

## ✅ 验证清单

### 代码验证
- [x] 前端组件编译无错误
- [x] 后端代码编译无错误
- [x] 未使用的导入已移除
- [x] 命令注册已更新

### 功能验证
- [ ] 设置页面正常显示
- [ ] 废弃提示正确显示
- [ ] 不会调用已移除的 API
- [ ] 其他功能不受影响

### 文档验证
- [x] 变更说明已创建
- [x] 技术细节已记录
- [ ] 用户文档已更新（如需要）

---

## 🚀 后续计划

### 短期计划（可选）

1. **完全移除 UI 选项**
   - 如果确认不需要保留
   - 从设置页面移除入口
   - 删除组件文件

2. **清理代码**
   - 删除注释掉的代码
   - 删除 `MigrationResult` DTO
   - 删除相关类型定义

### 长期计划

1. **文档归档**
   - 移动到归档目录
   - 标注为历史文档

2. **经验总结**
   - 记录架构演进
   - 总结迁移经验

---

## 📞 联系方式

如有疑问或发现问题，请联系：

- **项目维护者**: mcgeq
- **GitHub Issues**: https://github.com/mcgeq/miji/issues

---

## 📅 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2025-12-02 | 1.0.0 | 初始创建，移除数据迁移功能 | mcgeq |

---

**注意**: 此变更已测试，对现有功能无影响。如有任何问题，请及时反馈。
