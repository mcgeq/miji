# 家庭预算功能使用指南

## 📋 功能概述

家庭预算功能允许在家庭记账本中创建预算，并为家庭成员分配预算额度，实现精细化的家庭财务管理。

## 🎯 核心特性

### 1. 预算基本信息
- **预算名称**：自定义预算名称（如"2024年1月家庭预算"）
- **预算金额**：设置总预算金额
- **预算范围**：
  - 按分类：指定特定分类（餐饮、交通等）
  - 混合模式：账户+分类组合
- **重复周期**：支持无重复、每日、每周、每月、每年、自定义周期
- **起止日期**：设置预算有效期
- **预警设置**：
  - 百分比预警（如使用达到 80%）
  - 固定金额预警

### 2. 成员预算分配（可选）

创建预算时可以立即配置成员分配，也可以稍后配置。

#### 分配维度
- **按成员**：为某个成员分配预算
- **按分类**：为某个分类分配预算  
- **成员+分类**：为某个成员的某个分类分配预算（如"爸爸的餐饮预算"）

#### 分配方式
- **固定金额**：分配固定的金额（如 2000 元）
- **百分比**：分配总预算的百分比（如 30%）

#### 超支控制
- **禁止超支**：不允许超出分配额度
- **允许超支**：
  - 无限制
  - 百分比限制（如允许超支 10%）
  - 固定金额限制（如允许超支 500 元）

#### 预警设置
- 启用/禁用预警
- 预警阈值（80% 时提醒）
- 优先级（1-5）
- 强制标记（是否为必要支出）

## 📍 使用流程

### 方式一：从家庭记账本详情页创建

1. **进入家庭记账本详情页**
   ```
   导航：家庭记账本 → 选择账本 → 查看详情
   ```

2. **点击"创建家庭预算"按钮**
   - 位置：成员概览面板的右上角
   - 图标：🎯 目标图标

3. **填写预算基本信息**
   ```
   ✅ 预算名称：2024年1月家庭预算
   ✅ 预算金额：10,000
   ✅ 预算范围：分类
   ✅ 选择分类：餐饮、交通、娱乐
   ✅ 重复周期：每月
   ✅ 起止日期：2024-01-01 ~ 2024-12-31
   ✅ 预警阈值：80%
   ```

4. **配置成员预算分配（可选）**
   
   点击"添加分配"按钮，可以配置多个分配：
   
   **示例 1：固定金额分配**
   ```
   目标：成员
   成员：爸爸
   分类：餐饮
   金额类型：固定金额
   金额：2,000
   允许超支：否
   预警阈值：80%
   优先级：3
   ```
   
   **示例 2：百分比分配**
   ```
   目标：成员+分类
   成员：妈妈
   分类：交通
   金额类型：百分比
   百分比：20%
   允许超支：是
   超支限制类型：百分比
   超支限制值：10%
   预警阈值：85%
   优先级：4
   ```

5. **查看分配统计**
   
   在添加分配后，系统会自动计算：
   ```
   已分配金额：¥4,000.00 (剩余: ¥6,000.00)
   已分配百分比：40.0% (剩余: 60.0%)
   ```

6. **保存预算**
   
   点击确认按钮，系统会：
   - ✅ 创建预算记录
   - ✅ 创建所有成员分配记录
   - ✅ 显示成功提示

### 方式二：从预算管理页面创建

```
导航：MoneyView → 预算标签 → 新建预算
```

当前仅支持个人预算，家庭预算建议从家庭记账本中创建。

## 💡 使用场景示例

### 场景 1：月度家庭开销预算

```yaml
预算名称: 2024年1月家庭开销预算
预算金额: 15000
预算范围: 分类
选择分类: [餐饮, 交通, 日用品, 娱乐]
重复周期: 每月
成员分配:
  - 爸爸餐饮: 3000元 (固定)
  - 妈妈餐饮: 2500元 (固定)
  - 共同交通: 2000元 (固定)
  - 日用品: 30% (百分比)
```

### 场景 2：孩子教育预算

```yaml
预算名称: 孩子2024年教育预算
预算金额: 50000
预算范围: 分类
选择分类: [教育, 培训]
重复周期: 每年
成员分配:
  - 孩子学费: 30000元 (强制, 禁止超支)
  - 孩子兴趣班: 15000元 (允许超支10%)
  - 孩子图书资料: 5000元 (允许超支500元)
```

### 场景 3：旅游基金预算

```yaml
预算名称: 2024年家庭旅游基金
预算金额: 20000
预算范围: 分类
选择分类: [旅游, 娱乐]
重复周期: 每季度
成员分配:
  - 交通费: 40% (允许超支10%)
  - 住宿费: 35% (允许超支15%)
  - 餐饮娱乐: 25% (允许超支20%)
```

## 🔔 预警机制

### 预算级别预警
当预算总使用量达到阈值时触发：
```
✅ 使用量 >= 80% → 预警提示
❌ 使用量 >= 100% → 超支提示
```

### 分配级别预警
每个成员分配可独立设置预警：
```
示例：
爸爸的餐饮预算 2000元
- 使用 1600元 (80%) → 触发预警
- 使用 2100元 (105%) → 禁止超支 → 拒绝
```

## 📊 预算跟踪

### 自动更新
当家庭成员发生交易时，系统自动：
1. 匹配对应的预算和分配
2. 更新 `used_amount` 和 `remaining_amount`
3. 计算使用百分比 `usage_percentage`
4. 检查预警和超支限制
5. 触发通知（如果启用）

### 查看预算使用情况
```
导航：预算管理 → 预算分配详情
位置：/money/budget-allocations?budgetId=xxx
```

可以看到：
- 所有成员的分配列表
- 使用进度和剩余额度
- 预警状态
- 超支情况

## 🎨 UI 特性

### FamilyBudgetModal 组件
- ✅ 清晰的区块分组（基本信息 / 成员分配）
- ✅ 实时分配统计
- ✅ 分配卡片展示
- ✅ 嵌套模态框（分配编辑器）
- ✅ 表单验证

### 按钮样式
```css
创建家庭预算按钮:
- 位置：家庭记账本详情页 → 成员概览面板右上角
- 样式：主题色背景 + 悬停动画
- 图标：🎯 目标图标
```

## 🔧 技术实现

### 组件架构
```
FamilyLedgerDetailView.vue (家庭记账本详情页)
├── FamilyBudgetModal.vue (家庭预算模态框)
│   └── BudgetAllocationEditor.vue (分配编辑器)
└── useFamilyBudgetActions (预算操作 composable)
```

### API 调用流程
```typescript
1. budget_create({
     // accountSerialNum: null (关键)
     // familyLedgerSerialNum: 'xxx' (当前暂时通过后续关联)
     ...budgetData
   })
   
2. budget_allocation_create({
     budgetSerialNum: 'xxx',
     data: allocationData
   }) × N次（每个分配）
```

### 数据流
```
用户填写表单
  ↓
FamilyBudgetModal 验证数据
  ↓
emit('save', budgetData, allocations)
  ↓
useFamilyBudgetActions.createFamilyBudget()
  ↓
① 调用 budget_create
② 批量调用 budget_allocation_create
  ↓
显示成功提示
```

## ⚠️ 注意事项

### 1. 后端字段限制
当前后端 `BudgetCreate` 可能还没有 `family_ledger_serial_num` 字段。
需要通过以下方式之一解决：
- **方案 A**：后端添加该字段
- **方案 B**：创建预算后通过其他方式关联到家庭记账本

### 2. 分配总额验证
建议添加前端验证：
```typescript
// 固定金额不应超过预算总额
totalAllocatedAmount <= budgetAmount

// 百分比总和不应超过100%
totalPercentage <= 100
```

### 3. 预算范围限制
- 家庭预算不支持"按账户"范围
- 仅支持"按分类"和"混合"模式

## 🚀 后续优化建议

### 功能增强
1. **预算模板**：保存常用预算配置为模板
2. **自动分配**：按成员人数或历史数据自动分配
3. **预算调整**：中途调整预算和分配
4. **预算转结**：月底/年底自动结转剩余额度
5. **预算报表**：预算执行情况报表和图表

### UI 优化
1. 预算进度可视化（环形图、柱状图）
2. 分配冲突检测（重复分配提示）
3. 快速分配模式（平均分配、按比例分配）
4. 拖拽调整分配顺序

### 性能优化
1. 批量创建分配（一次 API 调用）
2. 乐观更新（先更新 UI 再调用 API）
3. 分配列表虚拟滚动（超过 50 条）

## 📖 相关文档

- [预算系统设计分析](../analysis/PHASE4_BUDGET_SYSTEM_ANALYSIS.md)
- [后端 DTO 定义](../../src-tauri/crates/money/src/dto/family_budget.rs)
- [数据库表结构](../database/financial/budget.md)
- [数据库表结构](../database/financial/budget_allocations.md)

## ❓ 常见问题

**Q1: 为什么创建家庭预算要从家庭记账本进入？**
A: 家庭预算必须关联到特定的家庭记账本，从记账本详情页创建可以自动关联。

**Q2: 可以不配置成员分配吗？**
A: 可以！成员分配是可选的。可以先创建预算，稍后在预算分配管理页面添加。

**Q3: 分配总额超过预算总额会怎样？**
A: 当前前端会显示剩余额度为负数，建议添加验证阻止提交。

**Q4: 如何修改已创建的预算分配？**
A: 导航到 `/money/budget-allocations?budgetId=xxx` 进行编辑。

**Q5: 预算到期后会自动失效吗？**
A: 当前需要手动停用。后续可以添加自动失效机制。

---

**最后更新**: 2024-11-25  
**版本**: 1.0.0  
**作者**: Miji Team
