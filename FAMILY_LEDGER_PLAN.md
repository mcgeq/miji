# 家庭账本功能开发计划

## 📋 功能清单概览

基于现有系统（已有基础数据库结构），在个人账本基础上添加家庭账本层。

---

## 🎯 第一阶段：基础架构（2-3周）

### 1.1 后端完善
- [x] 完善 Family 模块的业务逻辑
- [x] 实现权限验证中间件
- [x] 添加家庭成员统计 API
- [x] 实现分摊计算服务
- [x] 添加债务追踪服务

### 1.2 前端 Store 层
- [ ] 创建 `useFamilyLedgerStore`
  - 账本 CRUD
  - 账本切换
  - 账本统计
- [ ] 创建 `useFamilyMemberStore`
  - 成员 CRUD
  - 权限管理
  - 成员统计
- [ ] 创建 `useFamilySplitStore`
  - 分摊规则管理
  - 分摊计算
  - 模板管理

### 1.3 Schema 扩展
- [x] 扩展 `FamilyLedger` 类型
  - 添加账本类型、结算周期等字段
  - 添加统计字段
- [x] 扩展 `FamilyMember` 类型
  - 添加头像、颜色标识
  - 添加财务统计字段
- [x] 创建分摊相关 Schema
  - `SplitRuleConfig`
  - `SplitResult`
  - `DebtRelation`
  - `SettlementSuggestion`

---

## 🎯 第二阶段：核心功能（3-4周）

### 2.1 家庭账本管理
- [ ] 账本列表页面
  - 展示所有账本
  - 快速切换功能
  - 统计卡片展示
- [ ] 账本创建/编辑页面
  - 基本信息配置
  - 账本类型选择
  - 默认分摊规则设置
- [ ] 账本详情页面
  - 账本信息总览
  - 成员列表
  - 账户列表
  - 统计图表

### 2.2 成员管理
- [ ] 成员列表组件
  - 成员信息展示
  - 角色标识
  - 财务统计
- [ ] 成员添加/编辑
  - 基本信息表单
  - 角色选择
  - 权限配置
  - 头像/颜色选择
- [ ] 成员详情页
  - 个人统计
  - 交易记录
  - 分摊记录
  - 债务关系

### 2.3 权限系统
- [ ] 权限验证 Composable
  ```typescript
  // usePermission.ts
  const { hasPermission, canEdit, canDelete } = usePermission()
  ```
- [ ] 权限控制指令
  ```vue
  <button v-permission="'transaction:add'">添加交易</button>
  ```
- [ ] 角色管理界面
  - 预设角色展示
  - 自定义权限配置

---

## 🎯 第三阶段：费用分摊（2-3周）

### 3.1 分摊规则管理
- [ ] 分摊模板列表
  - 预设模板
  - 自定义模板
  - 模板编辑/删除
- [ ] 分摊规则配置器
  - 规则类型选择
  - 参与成员选择
  - 比例/金额设置
  - 预览分摊结果

### 3.2 交易分摊集成
- [ ] 扩展交易添加表单
  - 分摊开关
  - 模板选择
  - 实时计算显示
- [ ] 分摊交易列表
  - 分摊标识
  - 分摊详情展示
  - 成员分摊明细
- [ ] 分摊记录查询
  - 按成员筛选
  - 按状态筛选（已支付/未支付）
  - 导出功能

### 3.3 分摊计算引擎
- [x] 实现 `SplitCalculator` 类
  - 均摊算法
  - 比例分摊
  - 固定金额
  - 按比例权重
  - 尾数处理
- [x] 分摊验证
  - 总和验证
  - 参与者验证
  - 金额范围验证

---

## 🎯 第四阶段：结算系统（2-3周）

### 4.1 债务追踪
- [x] 债务计算服务
  - 实时计算成员债务
  - 债务关系图谱
  - 历史债务记录
- [ ] 债务提醒
  - 超过阈值提醒
  - 定期结算提醒
  - 债务变化通知

### 4.2 结算优化
- [x] 实现 `SettlementOptimizer` 类
  - 净余额计算
  - 最小转账次数算法
  - 结算方案生成
- [ ] 结算建议展示
  - 可视化债务关系
  - 一键生成转账记录
  - 结算历史记录

### 4.3 结算界面
- [ ] 结算总览页
  - 当前周期统计
  - 成员余额列表
  - 结算建议卡片
- [ ] 结算详情页
  - 详细债务明细
  - 相关交易列表
  - 结算操作按钮
- [ ] 结算记录
  - 历史结算列表
  - 结算详情查看
  - 导出功能

---

## 🎯 第五阶段：统计报表（2周）

### 5.1 家庭财务报表
- [x] 家庭收支统计
  - 总收入/总支出
  - 共同支出/个人支出
  - 分类统计
- [x] 成员贡献报表
  - 成员收入贡献
  - 成员支出占比
  - 分摊参与度
- [x] 趋势分析
  - 月度/季度/年度趋势
  - 成员对比图表
  - 预算执行情况

### 5.2 图表可视化
- [ ] ECharts 集成
  - 饼图：支出分类
  - 柱状图：成员对比
  - 折线图：趋势分析
  - 关系图：债务关系
- [ ] 数据导出
  - CSV 导出
  - PDF 报表生成
  - Excel 模板

---

## 🎯 第六阶段：高级功能（2-3周）

### 6.1 家庭预算
- [ ] 家庭预算创建
  - 基于家庭账本的预算
  - 成员分配预算
  - 分类预算
- [ ] 预算监控
  - 实时预算使用情况
  - 超支提醒
  - 预算调整建议

### 6.2 自动化功能
- [ ] 自动分摊规则
  - 基于分类的自动分摊
  - 基于金额范围的规则
  - 智能识别共同支出
- [ ] 定期结算
  - 自动计算结算周期
  - 自动生成结算建议
  - 结算提醒推送

### 6.3 账本归档
- [ ] 账本归档功能
  - 归档旧账本
  - 数据保留
  - 恢复功能
- [ ] 数据迁移
  - 成员数据迁移
  - 交易数据转移
  - 批量操作

---

## 📊 技术实现要点

### 数据模型设计

```typescript
// 核心实体关系
User (用户)
  ↓ 1:N
FamilyMember (家庭成员) ← 成员基本信息
  ↓ N:N
FamilyLedger (家庭账本) ← 账本管理
  ↓ 1:N
Account (账户) ← isShared=true 表示共享账户
  ↓ 1:N
Transaction (交易)
  ↓ 1:N
SplitRecord (分摊记录) ← splitMembers 字段
```

### 权限验证流程

```typescript
// 权限检查流程
1. 获取当前用户
2. 获取用户在当前账本中的成员信息
3. 获取成员角色和权限
4. 验证操作权限
5. 返回验证结果
```

### 分摊计算流程

```typescript
// 分摊计算流程
1. 获取交易金额
2. 获取分摊规则
3. 获取参与成员
4. 根据规则类型计算各成员金额
5. 处理尾数问题
6. 保存分摊记录
7. 更新成员债务关系
```

### 结算优化算法

```typescript
// 最小转账次数算法
1. 计算每个成员的净余额
   - 净余额 = 实际支付 - 应分摊
2. 分离债权人（余额>0）和债务人（余额<0）
3. 按金额大小排序
4. 贪心匹配：大债权对大债务
5. 生成最少转账方案
6. 返回结算建议
```

---

## 🎨 UI/UX 设计原则

### 1. 简洁直观
- 信息层级清晰
- 操作流程简单
- 关键数据突出显示

### 2. 快速操作
- 常用功能快捷入口
- 模板化操作
- 批量处理支持

### 3. 数据可视化
- 图表展示统计数据
- 颜色标识成员
- 债务关系可视化

### 4. 移动端友好
- 响应式布局
- 触摸优化
- 滑动操作

---

## 🚀 开发优先级

### P0 (必须实现)
1. ✅ 家庭账本基本管理（创建、编辑、切换）
2. ✅ 家庭成员管理（添加、编辑、角色）
3. ✅ 权限系统（角色权限、验证）
4. ✅ 费用分摊（均摊、比例分摊）
5. ✅ 基础结算（债务计算、结算建议）

### P1 (重要功能)
6. ✅ 分摊模板（预设、自定义）
7. ✅ 结算优化（最小转账次数）
8. ✅ 家庭统计报表（基础图表）
9. ✅ 成员财务统计
10. ✅ 自动分摊规则

### P2 (增强功能)
11. 🔮 家庭预算管理
12. 🔮 高级图表可视化
13. 🔮 账本归档
14. 🔮 数据导出
15. 🔮 定期结算提醒

---

## 📝 实现注意事项

### 数据一致性
- ✅ 交易分摊后不能随意修改参与成员
- ✅ 删除成员前检查历史数据
- ✅ 账本删除需确认数据迁移
- ✅ 结算后生成不可变记录

### 性能优化
- ✅ 统计数据缓存
- ✅ 大数据分页加载
- ✅ 债务关系增量计算
- ✅ 图表数据预聚合

### 用户体验
- ✅ 分摊金额实时预览
- ✅ 操作确认提示
- ✅ 错误信息友好提示
- ✅ 加载状态反馈

### 安全性
- ✅ 权限严格验证
- ✅ 敏感操作二次确认
- ✅ 操作日志记录
- ✅ 数据备份机制

---

## 📅 预估时间线

- **第一阶段（基础架构）**: 2-3 周
- **第二阶段（核心功能）**: 3-4 周
- **第三阶段（费用分摊）**: 2-3 周
- **第四阶段（结算系统）**: 2-3 周
- **第五阶段（统计报表）**: 2 周
- **第六阶段（高级功能）**: 2-3 周
- **测试与优化**: 2 周

**总计**: 约 15-20 周（3.5-5 个月）

---

## 🎯 里程碑

### M1: MVP 版本（6-8 周）
- ✅ 家庭账本管理
- ✅ 成员管理
- ✅ 基础权限
- ✅ 简单分摊（均摊）
- ✅ 基础结算

### M2: 完整版本（12-15 周）
- ✅ 所有分摊规则
- ✅ 结算优化
- ✅ 统计报表
- ✅ 自动化功能

### M3: 增强版本（18-20 周）
- ✅ 家庭预算
- ✅ 高级图表
- ✅ 账本归档
- ✅ 完整测试

---

## 🏆 完成状态总结

### ✅ 已完成功能（后端核心）
- **数据库层**: 6个新迁移文件，完整的表结构设计
- **Entity 层**: 4个新Entity + 2个扩展Entity + 完整枚举系统
- **DTO 层**: 4个新DTO模块 + 扩展现有DTO
- **服务层**: 7个核心服务 + 2个算法引擎
- **权限系统**: 完整的角色权限管理
- **统计分析**: 全方位的财务统计服务

### 🚧 待完成功能（前端界面）
- **Store 层**: 前端状态管理
- **组件层**: UI 组件和页面
- **可视化**: 图表和报表展示
- **API 层**: 控制器和路由

### 📊 完成进度
- **第一阶段**: 100% 完成（基础架构）
- **第二阶段**: 0% 完成（核心功能）
- **第三阶段**: 33% 完成（计算引擎完成）
- **第四阶段**: 50% 完成（后端算法完成）
- **第五阶段**: 50% 完成（后端统计完成）

**最后更新**: 2025-11-12
